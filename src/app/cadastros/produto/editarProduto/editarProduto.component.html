<h2>Produto</h2>
<hr width="100%">
<div class="box box-solid">
  <div class="box-header with-border">
    <tabset>
      <tab heading="Geral" style="margin-top: 10px;">
        <form [formGroup]="cadastroForm" class="mt-3">
          <div class="row mt-4">
            <div class="form-group col-md-5">
              <label>Descrição:(*)</label>
              <input style="text-transform: uppercase" oninput="this.value = this.value.toUpperCase()"
                class="form-control" type="text" formControlName="descricao" [ngClass]="{ 'is-invalid': cadastroForm.get('descricao').errors && 
                                        cadastroForm.get('descricao').touched}" />

              <div *ngIf="cadastroForm.get('descricao').hasError('required') &&cadastroForm.get('descricao').touched"
                class="invalid-feedback">
                Descrição é obrigatório.
              </div>
            </div>
          </div>
        </form>
      </tab>

      <tab heading="Produto Itens" style="margin-top: 20px;">
        <div style="margin-right: 15px;margin-bottom: 10px;" class="pull-right">
          <a (click)="novoItem(templateItem)" tooltip="Novo Item" class="btn btn-success">
            <i class="fa fa-plus-circle"></i>&nbsp; Novo Item
          </a>
        </div>

        <table class="table table-striped table-bordered mt-3">
          <thead class="thead-light">
            <tr>
              <th>Id</th>
              <th>Descrição</th>
              <th>Tipo</th>
              <th style="text-align: center;">Ações</th>
            </tr>
          </thead>
          <tbody *ngIf="produtoItens && produtoItens.length">
            <tr *ngFor="let Item of produtoItens">
              <td>{{ Item.id }}</td>
              <td style="white-space: nowrap;">{{ Item.descricao }}</td>
              <td style="white-space: nowrap;text-align: center;">
                <span style="margin-top:0px;" *ngIf="Item.tipoItem == 'RECEITA'" class="label label-info">
                  {{ Item.tipoItem }}
                </span>
                <span style="margin-top:0px;" *ngIf="Item.tipoItem != 'RECEITA'" class="label label-danger">
                  {{ Item.tipoItem }}
                </span>
                <span style="margin-left: 5px;margin-top:0px;" *ngIf="Item.tipoItem != 'RECEITA'"
                  class="label label-warning">
                  {{ Item.subTipoItem }}
                </span>
              </td>
              <td style="white-space: nowrap;text-align: center;">
                <div class="btn-group">
                  <a (click)="editarItem(templateItem, Item)" tooltip="Editar/Detalhes" class="btn btn-sm btn-primary">
                    <i class="fa fa-edit"></i>
                  </a>
                </div>
              </td>
            </tr>
          </tbody>

          <tfoot *ngIf="!produtoItens">
            <tr colspan="7" class="text-center"></tr>
            <h4>
              Nenhum Item encontrado!
            </h4>
          </tfoot>
        </table>
      </tab>
    </tabset>
  </div>
</div>
<button style="position:relative;" [disabled]="!cadastroForm.valid" (click)="salvarAlteracoes()" tooltip="Salvar"
  class="btn btn-lg btn-primary">
  &nbsp;Salvar Alterações
</button>


<div bsModal #templateItem="bs-modal" class="modal fade" tabindex="-1" role="dialog"
  aria-labelledby="dialog-sizes-name1">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <h4 id="dialog-sizes-name1" class="modal-title pull-left">
          Item
        </h4>
        <button type="button" class="close pull-right" (click)="templateItem.hide()" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <div class="modal-body">
        <form [formGroup]="cadastroItemForm">
          <input type="hidden" class="form-control" formControlName="id" value="0" placeholder="" />

          <div class="row">
            <div class="form-group col-md-8">
              <label>Tipo:</label>
              <ng-select [clearable]="false" [items]="tipos" [(ngModel)]="tipoSelecionado" formControlName="tipoItem">
              </ng-select>
              <div
                *ngIf="cadastroItemForm.get('tipoItem').hasError('required') &&cadastroItemForm.get('tipoItem').touched"
                class="invalid-feedback">
                Campo obrigatório.
              </div>
            </div>
          </div>

          <div *ngIf="tipoSelecionado == 'DESPESA'" class="row">
            <div class="form-group col-md-8">
              <label>SubTipo:</label>
              <ng-select [clearable]="false" [items]="subTipos" [(ngModel)]="subTipoSelecionado"
                formControlName="subTipoItem">
              </ng-select>
              <div
                *ngIf="cadastroItemForm.get('subTipoItem').hasError('required') &&cadastroItemForm.get('subTipoItem').touched"
                class="invalid-feedback">
                Campo obrigatório.
              </div>
            </div>
          </div>

          <div *ngIf="tipoSelecionado == 'DESPESA'" class="row">
            <div class="form-group col-md-8">
              <label>Centro de Despesa:</label>
              <ng-select  [clearable]="false" [items]="centrosDespesa" bindLabel="descricao" bindValue="id" [(ngModel)]="centroDespesaIdSelecionado"
                formControlName="centroDespesaId">
              </ng-select>
            </div>
          </div>

          <div *ngIf="tipoSelecionado == 'RECEITA'" class="row">
            <div class="form-group col-md-8">
              <label>Centro de Receita:</label>
              <ng-select  [clearable]="false" bindLabel="descricao" bindValue="id" [items]="centrosReceita" [(ngModel)]="centroReceitaIdSelecionado"
                formControlName="centroReceitaId">
              </ng-select>
            </div>
          </div>

          <div *ngIf="tipoSelecionado == 'RECEITA' || tipoSelecionado == 'DESPESA' " class="row">
            <div class="form-group col-md-10">
              <label>Plano de Conta:</label>

              <ng-select  *ngIf="tipoSelecionado == 'RECEITA'" style="text-transform: uppercase" [items]="planoContasReceita" bindLabel="descricao" required
                  bindValue="id" [(ngModel)]="planoContasIdSelecionado" formControlName="planoContasId">
                  <ng-template ng-option-tmp let-item="item" let-search="searchTerm">
                    <div><span></span><span [ngOptionHighlight]="search">{{item.descricao}}</span></div>
                    <small><b>Nível:</b> {{item.nivel}}</small> <br>
                    <small><b>Tipo:</b> {{item.tipo}}</small> <br>
                    <small><b>Categoria:</b> {{item.categoria}}</small>
                  </ng-template>
                </ng-select>
                <ng-select  *ngIf="tipoSelecionado != 'RECEITA'" style="text-transform: uppercase" [items]="planoContasDespesa" bindLabel="descricao" required
                  bindValue="id" [(ngModel)]="planoContasIdSelecionado" formControlName="planoContasId">
                  <ng-template ng-option-tmp let-item="item" let-search="searchTerm">
                    <div><span></span><span [ngOptionHighlight]="search">{{item.descricao}}</span></div>
                    <small><b>Nível:</b> {{item.nivel}}</small> <br>
                    <small><b>Tipo:</b> {{item.tipo}}</small> <br>
                    <small><b>Categoria:</b> {{item.categoria}}</small>
                  </ng-template>
                </ng-select>
              <div
                *ngIf="cadastroItemForm.get('planoContasId').hasError('required') &&cadastroItemForm.get('planoContasId').touched"
                class="invalid-feedback">
                Campo obrigatório.
              </div>
            </div>
          </div>

          <div class="row">
            <div class="form-group col-md-12">
              <label>Descrição:</label>
              <input type="text" class="form-control" style="text-transform: uppercase"
                oninput="this.value = this.value.toUpperCase()"
                [ngClass]="{'is-invalid':cadastroItemForm.get('descricao').errors &&cadastroItemForm.get('descricao').touched}"
                formControlName="descricao" />
              <div
                *ngIf="cadastroItemForm.get('descricao').hasError('required') &&cadastroItemForm.get('descricao').touched"
                class="invalid-feedback">
                Campo obrigatório.
              </div>
            </div>
          </div>

        </form>
      </div>
      <div class="modal-footer d-flex">
        <button class="btn btn-secondary" (click)="templateItem.hide()">
          Fechar
        </button>

        <button class="btn btn-primary ml-auto" [disabled]="!cadastroItemForm.valid"
          (click)="adicionarItem(templateItem)">
          Salvar Alterações
        </button>
      </div>
    </div>
  </div>